import{j as h,F as W}from"./emotion-react-jsx-runtime.browser.esm-B6nDGTOp.js";import{i as f}from"./inspectMessage-DlwZE6zu.js";import{s as q,o as x,c as V,p as B,b as N}from"./env-B2Oq9Sof.js";import{a as A}from"./assignDisplayName-lT0r0-ot.js";import{m as w,c as j,s as G}from"./traditional-B_ldJKp3.js";import{r as m}from"./index-qCb0-TeD.js";import{A as E,L as I,G as _}from"./appConstant-DrkG7OWi.js";import{c as Q}from"./dummy-T6UpgMGd.js";import{d as P}from"./define-D3i8B5cg.js";import{a as H}from"./config-e2J7_s0o.js";import{s as k}from"./index-FhjP52Um.js";import{p as K}from"./pick-BRmevVyy.js";import{i as $}from"./sentry-DXsovuw2.js";import{u as J}from"./uniq-BL7hiWVS.js";function Z(a,l){return(Array.isArray(a)?a:[a]).map(l)}function z(a){return l=>Z(l,a)}function X(a,{falsyString:l}={}){switch(typeof a){case"boolean":return a;case"string":return!["",...z(q())(l)].includes(a);default:return!!a}}function Y(a){return l=>X(l,a)}const g=P(),ee=a=>function(s){return s},te=function(){return{enabled:{autoEnableAt:Q},disabled:{autoEnableAt:void 0}}}(),ae=[...H.map(({code:a,displayName:l})=>({label:l,value:a})),{label:"Keys",value:"cimode"}],re=g({debugDivider:{type:"divider",label:"Debug Tools"},keepFeatureFlags:{type:"toggle",label:"Don't clear feature flags when last email changed"},alwaysHideDevModeFab:{type:"toggle",label:"Always hide Dev Mode FAB"},quickI18n:{label:"Quick switch language",type:"singleSelect",options:ae},overrideConversationHistoryAction:{label:"Chat: Override conversation history action",type:"singleSelect",options:[{value:"jumpTo",label:"Go to chat"},{value:"viewHistory",label:"View history"}]},reactQueryDevtool:{label:"Enable react-query devtool",type:"singleSelect",options:[{value:"bottom-right",label:"Bottom right"},{value:"top-left",label:"Top left"},{value:"top-right",label:"Top right"},{value:"bottom-left",label:"Bottom left"}]},periodicServiceWorkerUpdates:{type:"singleSelect",label:"Periodic Service Worker Updates",options:[{value:k(10).toString(),label:"10 seconds"},{value:k(30).toString(),label:"30 seconds"}]},renderMemberId:{type:"toggle",label:"Render member ID in the profile panel"},renderRawEcValue:{type:"toggle",label:"Render raw value from EC platform in the profile panel"},siteSelector:{type:"toggle",label:"Login: Site selector"},markAsRead:{type:"singleSelect",label:"Chat: Mark as read",options:[{value:"always"},{value:"never"}]},flutterWebviewAppDownload:{type:"singleSelect",label:"Enforce Flutter WebView App base64 download",options:[{value:"always"},{value:"never"}]},flutterWebviewAppOpenBrowser:{type:"singleSelect",label:"Enforce Flutter WebView App external link",options:[{value:"always"},{value:"never"}]}}),le=g({NextDivider:{type:"divider",label:"Next Features"},quickTemplateQuota:{type:"toggle",label:"Quick template: quota"},quickTemplateImport:{type:"toggle",label:"Quick template: import"},quickTemplateCreateFromMessage:{type:"toggle",label:"Quick template: create from message"}}),oe=g({releasedFeatures:{type:"divider",label:"Released Features"},aiQuickTemplate:{type:"toggle",label:"Chat: AI quick template",...te.enabled}}),ne=g({experimentalFeatures:{type:"divider",label:"Experimental Features"},originUrlOnly:{type:"toggle",label:"Chat: Use `originUrl` only, don't use `metadata.backup_media_url`"},deletedMessageFallback:{type:"toggle",label:"Chat: Show deleted message fallback instead of the original message"},notificationEmail:{type:"toggle",label:"Notification: email (TBD)"},aiUserManagement:{type:"toggle",label:"Settings: AI user management"}}),se=g({...re,...le,...oe,...ne}),F=ee()([{email:"crescender+meta@cresclab.com",feature:["alwaysHideDevModeFab"]}]),ie=se;function b(a){function l(e){const t=a[e];if(!t)throw new Error(f`config not found for key: ${e}`);return t.type==="toggle"}function s(e){const t=a[e];if(!t)throw new Error(f`config not found for key: ${e}`);return t.type==="singleSelect"}const o=Object.keys(a).filter(e=>l(e)||s(e)),i=K(a,o),v=x(w(i,e=>{switch(e.type){case"toggle":return t=>e.autoEnableAt!==void 0&&E>=e.autoEnableAt?!1:Y()(t);case"singleSelect":return t=>e.options.map(({value:r})=>r).includes(t)?t:null;default:throw e.type,new Error(f`Unhandled feature flag type: ${e}`)}}));function d(e){return c(r=>r.value[e])}function T(){const e=c(t=>t.value);return m.useCallback(t=>e[t],[e])}const C=e=>c.getState().value[e],{useStore:u}=V(I,v,{forUser:!1});function S(e){return w(e,(t,r)=>{const n=a[r];if(!n)throw new Error(f`config not found for key: ${r}`);return n.type==="toggle"&&n.autoEnableAt!==void 0&&E>=n.autoEnableAt?!0:t})}const c=j()(()=>({value:S(u.getState().value)}),G);u.subscribe(({value:e})=>{const t=S(e),r=c.getState().value;$(r,t)||c.setState({value:t})});function L(){return u(e=>Object.entries(i).some(([t])=>{const r=t,n=i[r];switch(n.type){case"toggle":return e.value[r];case"singleSelect":return e.value[r]!==null;default:return n.type,!1}}))}function U({feature:e,children:t}){const r=d(e);return m.useMemo(()=>h(W,{children:r?t:null}),[t,r])}function D(e,t,r=m.Fragment){const n=`withFeatureFlagWrapper(${e})`,p=m.forwardRef(A(function(M,R){const O=d(e)?t:r;return h(O,{...M,ref:R})},n));return A(p,n),p}return function(){const t=new URLSearchParams(window.location.search).get(_);if(t==="")u.getState().clear();else if(t!==null){const p=v(B(t,{fallback:null}));u.getState().setValue(p)}const r=new URL(window.location.href),n=new URLSearchParams(r.search);n.delete(_),r.search=n.toString(),window.history.replaceState({},"",r.toString())}(),{configs:a,FeatureFlag:U,getFeatureFlag:C,isSingleSelectFeatureFlagKey:s,isToggleFeatureFlagKey:l,useEnabledSomeFeatureFlags:L,useFeatureFlag:d,useFeatureFlagLocalStorageStore:u,useFeatureFlagStore:c,useGetFeatureFlag:T,withFeatureFlagWrapper:D}}const ue=b(ie);try{b.displayName="createFeatureFlagApi",b.__docgenInfo={description:"",displayName:"createFeatureFlagApi",props:{}}}catch{}try{CommonFeatureFlagsTypes.displayName="CommonFeatureFlagsTypes",CommonFeatureFlagsTypes.__docgenInfo={description:"This is for internal common components or functions, not for the app.",displayName:"CommonFeatureFlagsTypes",props:{}}}catch{}function ce(a){const l=Array.isArray(F)?F:[F],s=J(l.flatMap(o=>(Array.isArray(o.email)?o.email.includes(a):typeof o.email=="function"?o.email(a):o.email===a)?Array.isArray(o.feature)?o.feature:[o.feature]:[]));y.getState().setValue(o=>({...o,...Object.fromEntries(s.map(i=>[i,!0]))}))}const ge=ue,{getFeatureFlag:Le,useFeatureFlag:Ue,useFeatureFlagLocalStorageStore:y,useGetFeatureFlag:De}=ge;N.subscribe(a=>{y.getState().value.keepFeatureFlags||y.getState().clear(),a.value&&ce(a.value)});export{De as a,Le as g,Ue as u};
